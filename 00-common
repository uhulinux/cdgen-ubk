#!/bin/bash

# sourced by bash

# I know #!/bin/bash isn't needed, but it makes joe highlighting the syntax.

set -e

if [ $(id -u) != 0 ]; then
	echo "Hey, you gotta be root!" >&2
	exit 1
fi

export MAGICDATE="2008/01/11 00:00:00 UTC"

export LC_ALL=en_US.UTF-8
export LANG=C
unset  LANGUAGE
export lang="$(<language)"

export PATH=/sbin:/usr/sbin:/bin:/usr/bin

unset SORTDIR_LOCALE
unset SORTDIR_VERSCMP
unset SORTDIR_REVERSE

modprobe loop >/dev/null 2>&1 || true

WORKDIR="$PWD/Work"
ROOTDIR="$WORKDIR/root"
TMPDIR="$WORKDIR/tmp"
DVDDIR="$WORKDIR/DVD"
INSTALLERDIR="$WORKDIR/Installer.allfiles"
IMG_NAME="uhulinux.img"
ROIMG_NAME="uhulinux.roimg"
IMG="$WORKDIR/$IMG_NAME"
ROIMG="$WORKDIR/$ROIMG_NAME"

PACKAGES_ALL="$WORKDIR"/packages_all.txt
PACKAGES_CD="$WORKDIR"/packages_cd.txt

if [[ -f "$WORKDIR/UHU_RELEASE_FULL" ]]; then
	UHU_RELEASE_FULL="$(<"$WORKDIR/UHU_RELEASE_FULL")"
	UHU_RELEASE="${UHU_RELEASE_FULL%%-*}" # e.g. 2.0
elif [[ -f "$ROOTDIR/etc/uhu-release" ]]; then
	UHU_RELEASE_FULL="$(<"$ROOTDIR/etc/uhu-release")"
	UHU_RELEASE_FULL="${UHU_RELEASE_FULL%% *}" # e.g. 2.0-test1
	UHU_RELEASE="${UHU_RELEASE_FULL%%-*}" # e.g. 2.0
	echo $UHU_RELEASE_FULL > "$WORKDIR/UHU_RELEASE_FULL"
fi

if [ -n "${CDGEN_APT_SOURCES:-}" ]; then
	apt_sourcelist="-o Dir::Etc::SourceList=$CDGEN_APT_SOURCES"
else
	apt_sourcelist=""
fi
if [ -n "${CDGEN_APT_PREFERENCES:-}" ]; then
	apt_preferences="-o Dir::Etc::Preferences=$CDGEN_APT_PREFERENCES"
else
	apt_preferences=""
fi
apt_statedir="-o Dir::State=$ROOTDIR/var/state/apt"
apt_cachedir="-o Dir::Cache=$ROOTDIR/var/cache/apt"
apt_options="$apt_sourcelist $apt_preferences $apt_statedir $apt_cachedir"

echo -e "  \\e[1m${0##*/} ...\\e[0m"

mkdir -p "$ROOTDIR"
