#!/bin/bash -eu

. 00-common

if [[ $DESKTOP = "rescue" ]]; then
	echo "Create users: $USER, root"
	chroot "$ROOTDIR" useradd -m "$USER"
	echo "Set password for $USER"
	chroot "$ROOTDIR" passwd -d "$USER" &> /dev/null
	echo "Delete root's password"
	chroot "$ROOTDIR" passwd -d root &> /dev/null
else
	echo "Create users: uhu, root"
	chroot "$ROOTDIR" useradd -m uhu
	echo "Delete passwords for uhu, root"
	chroot "$ROOTDIR" passwd -d uhu &> /dev/null
	chroot "$ROOTDIR" passwd -d root &> /dev/null
fi

# gdm autologin
if [ -s "$ROOTDIR"/etc/gdm/custom.conf ]; then
	echo "Set gdm autologin"
	if [[ $DESKTOP = "rescue" ]]; then
		sed -ri -e '/^\s*AutomaticLogin/d' -e 's/\[daemon\]/[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin='$USER'/' "$ROOTDIR"/etc/gdm/custom.conf
	else
		sed -ri -e '/^\s*AutomaticLogin/d' -e 's/\[daemon\]/[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin=uhu/' "$ROOTDIR"/etc/gdm/custom.conf
	fi
	# enable gdm
	echo "Enable gdm"
	if [ ! -L "$ROOTDIR"/etc/systemd/system/gdm.service ]; then
		chroot "$ROOTDIR" systemctl enable gdm
	fi
fi

# lightdm autologin
if [ -s "$ROOTDIR"/etc/lightdm/lightdm.conf ]; then
	echo "Set lightdm autologin"
	if [[ $DESKTOP = "rescue" ]]; then
		sed -i -e 's/#pam-service=lightdm/pam-service=lightdm-autologin/' "$ROOTDIR"/etc/lightdm/lightdm.conf
		sed -i -e 's/#autologin-user=/autologin-user="$USER"/' "$ROOTDIR"/etc/lightdm/lightdm.conf
	#	sed -i -e 's/#autologin-in-background=false/autologin-in-background=true/' "$ROOTDIR"/etc/lightdm/lightdm.conf
	else
		sed -i -e 's/#pam-service=lightdm/pam-service=lightdm-autologin/' "$ROOTDIR"/etc/lightdm/lightdm.conf
		sed -i -e 's/#autologin-user=/autologin-user=uhu/' "$ROOTDIR"/etc/lightdm/lightdm.conf
	#	sed -i -e 's/#autologin-in-background=false/autologin-in-background=true/' "$ROOTDIR"/etc/lightdm/lightdm.conf
	fi
	# enable lightdm
	echo "Enable lightdm"
	if [ ! -L "$ROOTDIR"/etc/systemd/system/display-manager.service ]; then
		chroot "$ROOTDIR" systemctl enable lightdm
	fi
fi
